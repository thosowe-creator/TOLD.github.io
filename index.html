<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunwayReady - TOLD & Fuel Planning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 24px; }
        .input-field { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; background-color: white; }
        .label-text { display: block; font-size: 0.8rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; text-transform: uppercase; }
        .v-val { font-family: 'JetBrains Mono', monospace; font-size: 1.875rem; font-weight: 700; color: #2563eb; }
        .bar-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }
        .tab-btn { padding: 4px 12px; font-weight: 600; font-size: 0.75rem; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .told-title { font-weight: 900; letter-spacing: -0.05em; line-height: 1; }
        .to-color { color: #0ea5e9; }
        .ld-color { color: #92400e; }
        .fuel-color { color: #059669; }
        .thrust-toggle { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; gap: 4px; }
        .thrust-option { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.8rem; font-weight: 700; border-radius: 6px; cursor: pointer; color: #6b7280; }
        .thrust-option.active { background: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .wind-component { font-size: 0.7rem; font-weight: 700; margin-top: 4px; color: #6b7280; }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-4">
        <h1 class="told-title text-3xl md:text-5xl">
            <span class="to-color">TO</span><span class="ld-color">LD</span> <span class="text-gray-900">&</span> <span class="fuel-color">FUEL</span>
        </h1>
        
        <div class="flex flex-wrap items-center justify-center lg:justify-end gap-3 bg-white p-2 rounded-xl shadow-sm border border-gray-200 w-full lg:w-auto">
            <div class="flex border-r border-gray-100 pr-2">
                <button id="tab_airbus" class="tab-btn active" onclick="setManufacturer('Airbus')">Airbus</button>
                <button id="tab_boeing" class="tab-btn" onclick="setManufacturer('Boeing')">Boeing</button>
            </div>
            <select id="master_ac_type" class="bg-transparent font-bold text-gray-800 outline-none text-base md:text-lg cursor-pointer px-1 py-1" onchange="syncAircraft(this.value)"></select>
            <div id="engine_selector_container" class="hidden flex items-center px-2 border-l border-gray-200">
                <span class="text-[9px] font-extrabold text-gray-400 mr-2 bg-gray-100 px-1 rounded">ENG</span>
                <select id="master_engine_type" class="bg-transparent font-bold text-blue-600 outline-none text-xs md:text-sm cursor-pointer" onchange="calculateAll()"></select>
            </div>
            <div class="flex gap-1 p-1 bg-gray-50 rounded-lg">
                <button id="unit_tons" class="px-2 py-1 rounded-md text-[10px] font-bold shadow-sm bg-blue-600 text-white" onclick="setMasterUnit('tons')">METRIC</button>
                <button id="unit_lbs" class="px-2 py-1 rounded-md text-[10px] font-bold text-gray-500" onclick="setMasterUnit('lbs')">IMPERIAL</button>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Ïù¥Î•ô ÏÑπÏÖò (Takeoff) -->
        <section class="card border-t-8 border-sky-500">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üõ´</span>
                <h2 class="text-xl font-black text-sky-600 uppercase italic">Takeoff</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-full mb-2">
                    <label class="label-text">Ï∂îÎ†• ÏÑ§Ï†ï (Thrust)</label>
                    <div id="thrust_options_group" class="thrust-toggle"></div>
                </div>
                <div class="col-span-full">
                    <label class="label-text">ÌôúÏ£ºÎ°ú ÏÉÅÌÉú (Condition)</label>
                    <select id="to_rwy_cond" class="input-field font-bold text-blue-700" onchange="calculateAll()">
                        <option value="dry">DRY (Í±¥Ï°∞)</option>
                        <option value="wet">WET (Ï†ñÏùå)</option>
                        <option value="contaminated">CONTAMINATED (Ïò§Ïóº/ÎπôÌåê)</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">Ï§ëÎüâ (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="to_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">CG (% MAC)</label>
                    <input type="number" id="to_cg" class="input-field" value="25.0" step="0.1" max="50" oninput="validateRange(this, 0, 50); calculateAll()">
                </div>
                <div>
                    <label class="label-text">Ïù¥Î•ô ÌôúÏ£ºÎ°ú Î∞©ÏúÑ (0-360)</label>
                    <input type="number" id="to_rwy_hdg" class="input-field" value="320" min="0" max="360" oninput="validateRange(this, 0, 360); calculateAll()">
                </div>
                <div>
                    <label class="label-text">Î∞îÎûå (Dir/Spd)</label>
                    <div class="flex gap-1">
                        <input type="number" id="to_wdir" class="input-field text-center p-1" value="320" min="0" max="360" oninput="validateRange(this, 0, 360); calculateAll()">
                        <input type="number" id="to_wspd" class="input-field text-center p-1" value="10" min="0" max="99" oninput="validateRange(this, 0, 99); calculateAll()">
                    </div>
                    <div id="to_wind_info" class="wind-component">--</div>
                </div>
                <div>
                    <label class="label-text">ÌîåÎû© (Flaps)</label>
                    <select id="to_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div>
                    <label class="label-text">Ïù¥Î•ô ÌôúÏ£ºÎ°ú Í∏∏Ïù¥ (m)</label>
                    <input type="number" id="to_tora" class="input-field font-bold" value="3000" oninput="calculateAll()">
                </div>
            </div>
            <div id="to_results" class="mt-8 p-6 bg-sky-50/50 rounded-xl border border-sky-100">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">V1</p><p id="res_v1" class="v-val">--</p></div>
                    <div><p class="label-text">VR</p><p id="res_vr" class="v-val">--</p></div>
                    <div><p class="label-text">V2</p><p id="res_v2" class="v-val">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 font-medium" id="flex_label">FLEX</span><span id="res_flex" class="font-bold text-sky-700">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">STAB TRIM</span><span id="res_trim" class="font-bold text-gray-800">--</span></div>
                </div>
                <div class="mt-4"><div class="bar-container"><div id="to_bar" class="bar-fill bg-sky-500"></div></div></div>
            </div>
            <p id="to_warn" class="hidden mt-3 p-2 bg-red-50 text-red-600 text-[10px] rounded border border-red-200 font-bold"></p>
        </section>

        <!-- Ï∞©Î•ô ÏÑπÏÖò (Landing) -->
        <section class="card border-t-8 border-amber-800">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üõ¨</span>
                <h2 class="text-xl font-black text-amber-800 uppercase italic">Landing</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-text">Ï§ëÎüâ (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="ld_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Ï∞©Î•ô ÌôúÏ£ºÎ°ú Í∏∏Ïù¥ (m)</label>
                    <input type="number" id="ld_lda" class="input-field font-bold" value="3000" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Ï∞©Î•ô ÌôúÏ£ºÎ°ú Î∞©ÏúÑ (0-360)</label>
                    <input type="number" id="ld_rwy_hdg" class="input-field" value="140" min="0" max="360" oninput="validateRange(this, 0, 360); calculateAll()">
                </div>
                <div>
                    <label class="label-text">Í≤∞Ïã¨ Í≥†ÎèÑ (DA, ft)</label>
                    <input type="number" id="ld_da" class="input-field text-amber-700 font-bold" value="200" step="10" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Î∞îÎûå (Dir/Spd)</label>
                    <div class="flex gap-1">
                        <input type="number" id="ld_wdir" class="input-field text-center p-1" value="140" min="0" max="360" oninput="validateRange(this, 0, 360); calculateAll()">
                        <input type="number" id="ld_wspd" class="input-field text-center p-1" value="10" min="0" max="99" oninput="validateRange(this, 0, 99); calculateAll()">
                    </div>
                    <div id="ld_wind_info" class="wind-component">--</div>
                </div>
                <div>
                    <label class="label-text">ÌîåÎû© (Flaps)</label>
                    <select id="ld_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div class="col-span-full">
                    <label class="label-text">Ï†úÎèô ÏÑ§Ï†ï (Braking)</label>
                    <select id="ld_brake" class="input-field" onchange="calculateAll()"></select>
                </div>
            </div>
            <div id="ld_results" class="mt-8 p-6 bg-amber-50/50 rounded-xl border border-amber-100">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">VREF</p><p id="res_vref" class="v-val text-amber-900">--</p></div>
                    <div><p class="label-text">VAPP</p><p id="res_vapp" class="v-val text-amber-900">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">ÌïÑÏöî Í±∞Î¶¨</span><span id="res_fld" class="font-bold text-amber-950">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">Ïó¨Ïú† Í±∞Î¶¨</span><span id="res_margin" class="font-bold text-gray-800">--</span></div>
                    <!-- Ï∞©Î•ô Ìä∏Î¶º ÌëúÏãú Ï†úÍ±∞Îê® -->
                </div>
                <div class="mt-4"><div class="bar-container"><div id="ld_bar" class="bar-fill bg-amber-700"></div></div></div>
            </div>
            <p id="ld_warn" class="hidden mt-3 p-2 bg-red-50 text-red-600 text-[10px] rounded border border-red-200 font-bold"></p>
        </section>

        <!-- Ïó∞Î£å Í≥ÑÌöç ÏÑπÏÖò (Fuel Plan) -->
        <section class="card border-t-8 border-emerald-600">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">‚õΩ</span>
                <h2 class="text-xl font-black text-emerald-600 uppercase italic">Fuel Plan</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label class="label-text">Í±∞Î¶¨ (NM)</label>
                    <input type="number" id="fuel_dist" class="input-field" value="500" step="10" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Cost Index</label>
                    <input type="number" id="fuel_ci" class="input-field" value="20" step="1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ÌÉùÏã± Ïó∞Î£å (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_taxi" class="input-field" value="0.2" step="0.1" oninput="calculateAll()">
                </div>
                <div class="col-span-full">
                    <label class="label-text">Ï∞©Î•ô ÌõÑ ÏòàÎπÑ Ïó∞Î£å (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_reserve_input" class="input-field" value="3.5" step="0.1" oninput="calculateAll()">
                    <p class="text-[10px] text-gray-400 mt-1">ALTN/HOLD/FINAL RESV Ìè¨Ìï®</p>
                </div>
                <div class="col-span-full">
                    <label class="label-text">ÏòàÏÉÅ ÎπÑÌñâ ÏãúÍ∞Ñ</label>
                    <div id="res_time" class="p-3 bg-gray-50 rounded text-center font-bold mono">--:--</div>
                </div>
            </div>
            <div id="fuel_results" class="mt-8 p-6 bg-emerald-50/50 rounded-xl border border-emerald-100">
                <p class="label-text text-center">Ï¥ù ÌïÑÏöî Ïó∞Î£å (Block Fuel)</p>
                <p id="res_block" class="text-3xl font-black text-emerald-700 text-center mono mb-4">--</p>
                <div class="space-y-2 text-xs border-t border-emerald-100 pt-4">
                    <div class="flex justify-between"><span class="text-gray-500">TAXI</span><span id="res_taxi_out" class="font-bold">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">TRIP</span><span id="res_trip" class="font-bold">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">RESERVE (ALTN+)</span><span id="res_res" class="font-bold text-emerald-600">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">CONTINGENCY (5%)</span><span id="res_extra" class="font-bold">--</span></div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    /**
     * Ìï≠Í≥µ ÏÑ±Îä• Í≥µÌïô(Performance Engineering) Í∏∞Î∞ò TOLD Í≥ÑÏÇ∞ Î°úÏßÅ
     */

    const K_LBS = 2.20462;
    const KT_TO_MS = 0.514444; 
    const MS_TO_KT = 1.94384;
    const G_ACCEL = 9.80665;   

    const FLEET = {
        'A320-200': {
            mtow: 77.0, mlw: 66.0, oew: 42.6, burnRate: 2.4, cruiseSpeed: 450, climbFuel: 0.5, descentFuel: 0.3,
            toFlaps: [ {f:'1+F', cl:1.85, cd0:0.035, cl_max: 2.3, cm:-0.08}, {f:'2', cl:2.05, cd0:0.042, cl_max: 2.5, cm:-0.10}, {f:'3', cl:2.15, cd0:0.050, cl_max: 2.6, cm:-0.12} ],
            ldFlaps: [ {f:'FULL', cl:2.6, d:1.0, cm:-0.18}, {f:'3', cl:2.4, d:1.15, cm:-0.15} ],
            ldBrakes: [ {n:'MAX', decel:4.5}, {n:'MED', decel:3.0}, {n:'LOW', decel:1.8} ],
            vRefBase: 136, trim_type: 'THS', 
            s_area: 122.6, engines: { 'CFM56': { thrust_kn: 120 }, 'IAE2500': { thrust_kn: 110 } }
        },
        'A321-200': {
            mtow: 93.5, mlw: 77.8, oew: 48.5, burnRate: 2.8, cruiseSpeed: 450, climbFuel: 0.6, descentFuel: 0.35,
            toFlaps: [ {f:'1+F', cl:1.82, cd0:0.038, cl_max: 2.2, cm:-0.09}, {f:'2', cl:2.00, cd0:0.045, cl_max: 2.4, cm:-0.11}, {f:'3', cl:2.10, cd0:0.055, cl_max: 2.5, cm:-0.13} ],
            ldFlaps: [ {f:'FULL', cl:2.55, d:1.0, cm:-0.20}, {f:'3', cl:2.35, d:1.18, cm:-0.16} ],
            ldBrakes: [ {n:'MAX', decel:4.2}, {n:'MED', decel:2.8}, {n:'LOW', decel:1.6} ],
            vRefBase: 145, trim_type: 'THS',
            s_area: 126.0, engines: { 'CFM56': { thrust_kn: 140 }, 'IAE2500': { thrust_kn: 147 } }
        },
        'A330-300': {
            mtow: 242.0, mlw: 187.0, oew: 125.0, burnRate: 5.6, cruiseSpeed: 470, climbFuel: 1.2, descentFuel: 0.6,
            toFlaps: [ {f:'1+F', cl:1.95, cd0:0.04, cl_max: 2.4, cm:-0.12}, {f:'2', cl:2.15, cd0:0.05, cl_max: 2.6, cm:-0.14}, {f:'3', cl:2.25, cd0:0.06, cl_max: 2.7, cm:-0.16} ],
            ldFlaps: [ {f:'FULL', cl:2.7, d:1.0, cm:-0.24}, {f:'3', cl:2.5, d:1.12, cm:-0.20} ],
            ldBrakes: [ {n:'MAX', decel:3.8}, {n:'MED', decel:2.5}, {n:'LOW', decel:1.4} ],
            vRefBase: 148, trim_type: 'THS',
            s_area: 361.6, engines: { 'TRENT700': { thrust_kn: 316 }, 'PW4000': { thrust_kn: 300 } }
        },
        'B737-800': {
            mtow: 79.0, mlw: 66.3, oew: 41.4, burnRate: 2.5, cruiseSpeed: 445, climbFuel: 0.5, descentFuel: 0.3,
            toFlaps: [ {f:'1', cl:1.80, cd0:0.03, cl_max: 2.2, cm:-0.05}, {f:'5', cl:1.95, cd0:0.04, cl_max: 2.4, cm:-0.07}, {f:'15', cl:2.08, cd0:0.052, cl_max: 2.5, cm:-0.09} ],
            ldFlaps: [ {f:'30', cl:2.5, d:1.0, cm:-0.15}, {f:'40', cl:2.7, d:0.95, cm:-0.18} ],
            ldBrakes: [ {n:'MAX', decel:4.8}, {n:'3', decel:3.5}, {n:'2', decel:2.2}, {n:'1', decel:1.2} ],
            vRefBase: 142, trim_type: 'ANU',
            s_area: 124.6, engines: { 'CFM56-7B': { thrust_kn: 121 } }
        },
        'B777-200ER': {
            mtow: 297.5, mlw: 213.1, oew: 138.1, burnRate: 6.8, cruiseSpeed: 490, climbFuel: 1.5, descentFuel: 0.8,
            toFlaps: [ {f:'5', cl:1.90, cd0:0.035, cl_max: 2.35, cm:-0.10}, {f:'15', cl:2.05, cd0:0.045, cl_max: 2.5, cm:-0.13}, {f:'20', cl:2.15, cd0:0.055, cl_max: 2.6, cm:-0.15} ],
            ldFlaps: [ {f:'30', cl:2.65, d:1.0, cm:-0.22}, {f:'25', cl:2.45, d:1.1, cm:-0.18} ],
            ldBrakes: [ {n:'MAX', decel:4.0}, {n:'4', decel:3.2}, {n:'3', decel:2.4}, {n:'2', decel:1.6}, {n:'1', decel:1.0} ],
            vRefBase: 152, trim_type: 'ANU',
            s_area: 427.8, engines: { 'PW4090': { thrust_kn: 400 }, 'GE90-94B': { thrust_kn: 418 }, 'TRENT895': { thrust_kn: 415 } }
        },
        'B777-300ER': {
            mtow: 351.5, mlw: 251.2, oew: 167.8, burnRate: 7.5, cruiseSpeed: 490, climbFuel: 1.8, descentFuel: 1.0,
            toFlaps: [ {f:'5', cl:1.88, cd0:0.038, cl_max: 2.3, cm:-0.12}, {f:'15', cl:2.02, cd0:0.048, cl_max: 2.45, cm:-0.15}, {f:'20', cl:2.12, cd0:0.058, cl_max: 2.55, cm:-0.17} ],
            ldFlaps: [ {f:'30', cl:2.6, d:1.0, cm:-0.25}, {f:'25', cl:2.4, d:1.08, cm:-0.21} ],
            ldBrakes: [ {n:'MAX', decel:3.9}, {n:'4', decel:3.1}, {n:'3', decel:2.3}, {n:'2', decel:1.5}, {n:'1', decel:0.9} ],
            vRefBase: 158, trim_type: 'ANU',
            s_area: 436.8, engines: { 'GE90-115B': { thrust_kn: 512 } }
        }
    };

    let curUnit = 'tons';
    let curMfr = 'Airbus';
    let curMode = 'FLEX';

    function validateRange(el, min, max) {
        let val = parseFloat(el.value);
        if (isNaN(val)) return;
        if (val < min) el.value = min;
        if (val > max) el.value = max;
    }

    function setManufacturer(mfr) {
        curMfr = mfr;
        document.getElementById('tab_airbus').classList.toggle('active', mfr === 'Airbus');
        document.getElementById('tab_boeing').classList.toggle('active', mfr === 'Boeing');
        
        const sel = document.getElementById('master_ac_type');
        sel.innerHTML = '';
        Object.keys(FLEET).filter(k => k.startsWith(mfr === 'Airbus' ? 'A' : 'B')).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k; opt.innerText = k; sel.appendChild(opt);
        });
        curMode = mfr === 'Airbus' ? 'FLEX' : 'TO';
        renderThrustUI();
        syncAircraft(sel.value);
    }

    function renderThrustUI() {
        const g = document.getElementById('thrust_options_group');
        g.innerHTML = '';
        const modes = curMfr === 'Airbus' ? ['FLEX', 'TOGA'] : ['TO', 'TO-1', 'TO-2'];
        modes.forEach(m => {
            const d = document.createElement('div');
            d.className = `thrust-option ${curMode === m ? 'active' : ''}`;
            d.innerText = m;
            d.onclick = () => { curMode = m; renderThrustUI(); calculateAll(); };
            g.appendChild(d);
        });
    }

    function syncAircraft(val) {
        const ac = FLEET[val];
        if(!ac) return;

        const es = document.getElementById('master_engine_type');
        es.innerHTML = '';
        Object.keys(ac.engines).forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.innerText = k; es.appendChild(opt);
        });
        document.getElementById('engine_selector_container').classList.toggle('hidden', Object.keys(ac.engines).length < 2);

        const factor = curUnit === 'lbs' ? K_LBS : 1;
        document.getElementById('to_weight').value = (ac.mtow * 0.85 * factor).toFixed(1);
        document.getElementById('ld_weight').value = (ac.mlw * 0.85 * factor).toFixed(1);
        document.getElementById('fuel_reserve_input').value = (ac.mtow > 200 ? 10 : 3.5 * factor).toFixed(1);
        document.getElementById('fuel_taxi').value = (ac.mtow > 200 ? 0.7 : 0.2 * factor).toFixed(1);

        const tf = document.getElementById('to_flaps'); tf.innerHTML = '';
        ac.toFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; tf.appendChild(o); });
        const lf = document.getElementById('ld_flaps'); lf.innerHTML = '';
        ac.ldFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; lf.appendChild(o); });
        const lb = document.getElementById('ld_brake'); lb.innerHTML = '';
        ac.ldBrakes.forEach((b, i) => { const o = document.createElement('option'); o.value = b.decel; o.innerText = b.n; lb.appendChild(o); });

        calculateAll();
    }

    function setMasterUnit(u) {
        if(curUnit === u) return;
        const factor = u === 'lbs' ? K_LBS : (1/K_LBS);
        ['to_weight', 'ld_weight', 'fuel_reserve_input', 'fuel_taxi'].forEach(id => {
            const el = document.getElementById(id);
            el.value = (parseFloat(el.value) * factor).toFixed(1);
        });
        document.querySelectorAll('.unit-text').forEach(t => t.innerText = u === 'lbs' ? 'Lbs' : 'Tons');
        curUnit = u;
        calculateAll();
    }

    function computeStabTrim(ac, cg, mass_kg, flap, isLanding = false) {
        const activeCG = Math.max(15, Math.min(50, cg)); 
        const weightRatio = mass_kg / (ac.mtow * 1000);
        const flapFactor = flap.cm * -2.5; 

        if (ac.trim_type === 'THS') {
            let baseTrim = (25 - activeCG) * 0.16; 
            baseTrim += (weightRatio - 0.7) * 0.5;
            baseTrim += flapFactor * 0.3;
            if (isLanding) baseTrim *= 1.2;
            const absTrim = Math.abs(baseTrim).toFixed(1);
            return (baseTrim >= 0 ? 'UP ' : 'DN ') + absTrim;
        } else {
            let baseANU = 0;
            if (ac.s_area < 200) { 
                baseANU = 7.5 - (activeCG - 15) * 0.18;
            } else { 
                baseANU = 6.2 - (activeCG - 15) * 0.12;
            }
            baseANU += (weightRatio - 0.8) * 0.8;
            baseANU += Math.abs(flap.cm) * 4.0;
            if (isLanding) baseANU += 0.5; 
            return Math.max(1.0, Math.min(12.0, baseANU)).toFixed(1) + " ANU";
        }
    }

    function calculateAll() {
        const acId = document.getElementById('master_ac_type').value;
        const ac = FLEET[acId];
        if(!ac) return;
        const engId = document.getElementById('master_engine_type').value;
        const eng = ac.engines[engId] || Object.values(ac.engines)[0];

        calculateTakeoff(ac, eng);
        calculateLanding(ac);
        calculateFuel(ac);
    }

    function calculateTakeoff(ac, eng) {
        const w_raw = parseFloat(document.getElementById('to_weight').value) || 0;
        const weight_tons = (curUnit === 'lbs' ? w_raw / K_LBS : w_raw);
        const mass_kg = weight_tons * 1000;
        const tora = parseFloat(document.getElementById('to_tora').value) || 1;
        const cg = parseFloat(document.getElementById('to_cg').value) || 25;
        const flapIdx = document.getElementById('to_flaps').value;
        const flap = ac.toFlaps[flapIdx] || ac.toFlaps[0];
        const rwyCond = document.getElementById('to_rwy_cond').value;
        
        const warn = document.getElementById('to_warn');
        const resDiv = document.getElementById('to_results');

        if(mass_kg > (ac.mtow * 1050) || mass_kg < (ac.oew * 900)) {
            warn.innerText = `‚ö†Ô∏è WEIGHT LIMIT EXCEEDED`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); return;
        }

        const { head, cross } = getWindComponents('to_wdir', 'to_wspd', 'to_rwy_hdg');
        document.getElementById('to_wind_info').innerText = `HW: ${head >= 0 ? head : 0}kt, TW: ${head < 0 ? Math.abs(head) : 0}kt, XW: ${cross}kt`;

        const rho = 1.225;
        const vr_ias_ms = Math.sqrt((2 * mass_kg * G_ACCEL) / (rho * ac.s_area * flap.cl * 0.88)); 
        const vr = vr_ias_ms * MS_TO_KT;
        const vs_ms = Math.sqrt((2 * mass_kg * G_ACCEL) / (rho * ac.s_area * flap.cl_max));
        
        let thrust_factor = 1.0;
        if(curMode === 'FLEX' || curMode === 'TO-2') thrust_factor = 1.05; 
        
        let v2 = (vs_ms * 1.2 * thrust_factor) * MS_TO_KT;
        if (v2 < vr + 5) v2 = vr + 5;

        let current_gs_ms = 0;
        let distance = 0;
        let dt = 0.5;
        let thrust_n = eng.thrust_kn * 1000 * 2.1; 
        if(curMode === 'FLEX') thrust_n *= 0.85;
        if(curMode === 'TO-1') thrust_n *= 0.92;
        if(curMode === 'TO-2') thrust_n *= 0.82;

        let mu = rwyCond === 'dry' ? 0.02 : (rwyCond === 'wet' ? 0.04 : 0.08);

        for(let i=0; i<400; i++) {
            let ias = current_gs_ms + (head * KT_TO_MS);
            if(ias >= vr_ias_ms) break;
            let drag = 0.5 * rho * Math.pow(Math.max(0, ias), 2) * ac.s_area * flap.cd0;
            let lift = 0.5 * rho * Math.pow(Math.max(0, ias), 2) * ac.s_area * (flap.cl * 0.3);
            let accel = (thrust_n - drag - (Math.max(0, mass_kg*G_ACCEL - lift) * mu)) / mass_kg;
            current_gs_ms += accel * dt;
            distance += current_gs_ms * dt;
        }

        let v1 = vr - (rwyCond === 'dry' ? 4 : 10);
        const final_dist = distance * 1.15;

        if(final_dist > tora) {
            warn.innerText = `‚ö†Ô∏è RUNWAY LIMITED: ${Math.round(final_dist)}m REQUIRED`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); 
        } else {
            warn.classList.add('hidden'); resDiv.classList.remove('opacity-30');
        }

        document.getElementById('res_v1').innerText = Math.round(v1);
        document.getElementById('res_vr').innerText = Math.round(vr);
        document.getElementById('res_v2').innerText = Math.round(v2);
        document.getElementById('to_bar').style.width = Math.min((final_dist/tora)*100, 100) + '%';
        
        document.getElementById('res_trim').innerText = computeStabTrim(ac, cg, mass_kg, flap, false);
        document.getElementById('res_flex').innerText = curMfr === 'Airbus' ? (curMode === 'FLEX' ? '+52¬∞C' : 'TOGA') : curMode;
    }

    function calculateLanding(ac) {
        const w_raw = parseFloat(document.getElementById('ld_weight').value) || 0;
        const mass_kg = (curUnit === 'lbs' ? w_raw / K_LBS : w_raw) * 1000;
        const lda = parseFloat(document.getElementById('ld_lda').value) || 1;
        const flapIdx = document.getElementById('ld_flaps').value;
        const flap = ac.ldFlaps[flapIdx] || ac.ldFlaps[0];
        const decel_val = parseFloat(document.getElementById('ld_brake').value) || 2;
        
        const warn = document.getElementById('ld_warn');
        const resDiv = document.getElementById('ld_results');

        const { head } = getWindComponents('ld_wdir', 'ld_wspd', 'ld_rwy_hdg');
        document.getElementById('ld_wind_info').innerText = `HW: ${head >= 0 ? head : 0}kt, TW: ${head < 0 ? Math.abs(head) : 0}kt`;

        const vref = ac.vRefBase * Math.sqrt(mass_kg / (ac.mlw * 1000));
        const vapp = vref + Math.max(5, Math.min(15, head > 0 ? head / 3 : 5));

        const gs_td_ms = Math.max(10, (vref - 5 - head) * KT_TO_MS);
        const braking_dist = Math.pow(gs_td_ms, 2) / (2 * decel_val);
        const total_ld_dist = ((vref * KT_TO_MS * 6.0) + braking_dist) * 1.15; 

        if(total_ld_dist > lda) {
            warn.innerText = `‚ö†Ô∏è OVERRUN RISK: ${Math.round(total_ld_dist)}m REQUIRED`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30');
        } else {
            warn.classList.add('hidden'); resDiv.classList.remove('opacity-30');
        }

        document.getElementById('res_vref').innerText = Math.round(vref);
        document.getElementById('res_vapp').innerText = Math.round(vapp);
        document.getElementById('res_fld').innerText = Math.round(total_ld_dist) + ' m';
        document.getElementById('res_margin').innerText = Math.round(lda - total_ld_dist) + ' m';
        document.getElementById('ld_bar').style.width = Math.min((total_ld_dist/lda)*100, 100) + '%';
    }

    function calculateFuel(ac) {
        const dist = parseFloat(document.getElementById('fuel_dist').value) || 0;
        const ci = parseFloat(document.getElementById('fuel_ci').value) || 0;
        const inputTaxi = parseFloat(document.getElementById('fuel_taxi').value) || 0;
        const inputReserve = parseFloat(document.getElementById('fuel_reserve_input').value) || 0;
        const f = curUnit === 'lbs' ? K_LBS : 1;

        const speed = ac.cruiseSpeed || 450;
        const burn = ac.burnRate || 2.5;
        const tas = speed + (ci * 0.15); 
        const cruise_time = dist / tas;
        const trip_fuel = (burn * (1 + ci/1000)) * cruise_time + (ac.climbFuel || 0.5) + (ac.descentFuel || 0.3);

        const block_fuel = (inputTaxi/f) + trip_fuel + (trip_fuel * 0.05) + (inputReserve/f);
        const time_hrs = cruise_time + 0.5; 
        
        document.getElementById('res_time').innerText = `${Math.floor(time_hrs).toString().padStart(2,'0')}:${Math.floor((time_hrs%1)*60).toString().padStart(2,'0')}`;
        document.getElementById('res_block').innerText = (block_fuel * f).toFixed(1) + (curUnit === 'lbs' ? ' LBS' : ' T');
        document.getElementById('res_taxi_out').innerText = (inputTaxi).toFixed(1);
        document.getElementById('res_trip').innerText = (trip_fuel * f).toFixed(1);
        document.getElementById('res_res').innerText = (inputReserve).toFixed(1);
        document.getElementById('res_extra').innerText = (trip_fuel * 0.05 * f).toFixed(1);
    }

    function getWindComponents(wdirId, wspdId, rhdgId) {
        const wdir = parseFloat(document.getElementById(wdirId).value) || 0;
        const wspd = parseFloat(document.getElementById(wspdId).value) || 0;
        const rhdg = parseFloat(document.getElementById(rhdgId).value) || 0;
        const diffRad = (wdir - rhdg) * Math.PI / 180;
        return { head: Math.round(wspd * Math.cos(diffRad)), cross: Math.round(Math.abs(wspd * Math.sin(diffRad))) };
    }

    window.onload = () => setManufacturer('Airbus');
</script>
</body>
</html>
